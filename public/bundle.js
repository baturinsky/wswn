!function(){"use strict";function e(e,t,n,o){return new(n||(n=Promise))(function(s,r){function i(e){try{l(o.next(e))}catch(e){r(e)}}function a(e){try{l(o.throw(e))}catch(e){r(e)}}function l(e){e.done?s(e.value):new n(function(t){t(e.value)}).then(i,a)}l((o=o.apply(e,t||[])).next())})}var t,n,o,s,r,i={},a=[],l=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|^--/i;function u(e,t){for(var n in t)e[n]=t[n];return e}function c(e){var t=e.parentNode;t&&t.removeChild(e)}function h(e,t,n){var o,s,r,i,a=arguments;if(t=u({},t),arguments.length>3)for(n=[n],o=3;o<arguments.length;o++)n.push(a[o]);if(null!=n&&(t.children=n),null!=e&&null!=e.defaultProps)for(s in e.defaultProps)void 0===t[s]&&(t[s]=e.defaultProps[s]);return i=t.key,null!=(r=t.ref)&&delete t.ref,null!=i&&delete t.key,p(e,t,i,r)}function p(e,n,o,s){var r={type:e,props:n,key:o,ref:s,__k:null,__p:null,__b:0,__e:null,l:null,__c:null,constructor:void 0};return t.vnode&&t.vnode(r),r}function d(e){return e.children}function v(e,t){this.props=e,this.context=t}function f(e,t){if(null==t)return e.__p?f(e.__p,e.__p.__k.indexOf(e)+1):null;for(var n;t<e.__k.length;t++)if(null!=(n=e.__k[t])&&null!=n.__e)return n.__e;return"function"==typeof e.type?f(e):null}function _(e){var t,n;if(null!=(e=e.__p)&&null!=e.__c){for(e.__e=e.__c.base=null,t=0;t<e.__k.length;t++)if(null!=(n=e.__k[t])&&null!=n.__e){e.__e=e.__c.base=n.__e;break}return _(e)}}function g(e){(!e.__d&&(e.__d=!0)&&1===n.push(e)||s!==t.debounceRendering)&&(s=t.debounceRendering,(t.debounceRendering||o)(m))}function m(){var e,t,o,s,r,i,a,l;for(n.sort(function(e,t){return t.__v.__b-e.__v.__b});e=n.pop();)e.__d&&(o=void 0,s=void 0,i=(r=(t=e).__v).__e,a=t.__P,l=t.u,t.u=!1,a&&(o=[],s=S(a,r,u({},r),t.__n,void 0!==a.ownerSVGElement,null,o,l,null==i?f(r):i),M(o,r),s!=i&&_(r)))}function y(e,t,n,o,s,r,l,u,h){var p,d,v,_,g,m,y,P=n&&n.__k||a,w=P.length;if(u==i&&(u=null!=r?r[0]:w?f(n,0):null),p=0,t.__k=b(t.__k,function(n){if(null!=n){if(n.__p=t,n.__b=t.__b+1,null===(v=P[p])||v&&n.key==v.key&&n.type===v.type)P[p]=void 0;else for(d=0;d<w;d++){if((v=P[d])&&n.key==v.key&&n.type===v.type){P[d]=void 0;break}v=null}if(_=S(e,n,v=v||i,o,s,r,l,null,u,h),(d=n.ref)&&v.ref!=d&&(y||(y=[])).push(d,n.__c||_,n),null!=_){if(null==m&&(m=_),null!=n.l)_=n.l,n.l=null;else if(r==v||_!=u||null==_.parentNode){e:if(null==u||u.parentNode!==e)e.appendChild(_);else{for(g=u,d=0;(g=g.nextSibling)&&d<w;d+=2)if(g==_)break e;e.insertBefore(_,u)}"option"==t.type&&(e.value="")}u=_.nextSibling,"function"==typeof t.type&&(t.l=_)}}return p++,n}),t.__e=m,null!=r&&"function"!=typeof t.type)for(p=r.length;p--;)null!=r[p]&&c(r[p]);for(p=w;p--;)null!=P[p]&&I(P[p],P[p]);if(y)for(p=0;p<y.length;p++)A(y[p],y[++p],y[++p])}function b(e,t,n){if(null==n&&(n=[]),null==e||"boolean"==typeof e)t&&n.push(t(null));else if(Array.isArray(e))for(var o=0;o<e.length;o++)b(e[o],t,n);else n.push(t?t(function(e){if(null==e||"boolean"==typeof e)return null;if("string"==typeof e||"number"==typeof e)return p(null,e,null,null);if(null!=e.__e||null!=e.__c){var t=p(e.type,e.props,e.key,null);return t.__e=e.__e,t}return e}(e)):e);return n}function P(e,t,n){"-"===t[0]?e.setProperty(t,n):e[t]="number"==typeof n&&!1===l.test(t)?n+"px":null==n?"":n}function w(e,t,n,o,s){var r,i,a,l,u;if("key"===(t=s?"className"===t?"class":t:"class"===t?"className":t)||"children"===t);else if("style"===t)if(r=e.style,"string"==typeof n)r.cssText=n;else{if("string"==typeof o&&(r.cssText="",o=null),o)for(i in o)n&&i in n||P(r,i,"");if(n)for(a in n)o&&n[a]===o[a]||P(r,a,n[a])}else"o"===t[0]&&"n"===t[1]?(l=t!==(t=t.replace(/Capture$/,"")),u=t.toLowerCase(),t=(u in e?u:t).slice(2),n?(o||e.addEventListener(t,k,l),(e.t||(e.t={}))[t]=n):e.removeEventListener(t,k,l)):"list"!==t&&"tagName"!==t&&"form"!==t&&!s&&t in e?e[t]=null==n?"":n:"function"!=typeof n&&"dangerouslySetInnerHTML"!==t&&(t!==(t=t.replace(/^xlink:?/,""))?null==n||!1===n?e.removeAttributeNS("http://www.w3.org/1999/xlink",t.toLowerCase()):e.setAttributeNS("http://www.w3.org/1999/xlink",t.toLowerCase(),n):null==n||!1===n?e.removeAttribute(t):e.setAttribute(t,n))}function k(e){return this.t[e.type](t.event?t.event(e):e)}function S(e,n,o,s,r,i,a,l,c,h){var p,f,_,g,m,P,w,k,S,M,A=n.type;if(void 0!==n.constructor)return null;(p=t.__b)&&p(n);try{e:if("function"==typeof A){if(k=n.props,S=(p=A.contextType)&&s[p.__c],M=p?S?S.props.value:p.__p:s,o.__c?w=(f=n.__c=o.__c).__p=f.__E:("prototype"in A&&A.prototype.render?n.__c=f=new A(k,M):(n.__c=f=new v(k,M),f.constructor=A,f.render=C),S&&S.sub(f),f.props=k,f.state||(f.state={}),f.context=M,f.__n=s,_=f.__d=!0,f.__h=[]),null==f.__s&&(f.__s=f.state),null!=A.getDerivedStateFromProps&&u(f.__s==f.state?f.__s=u({},f.__s):f.__s,A.getDerivedStateFromProps(k,f.__s)),_)null==A.getDerivedStateFromProps&&null!=f.componentWillMount&&f.componentWillMount(),null!=f.componentDidMount&&a.push(f);else{if(null==A.getDerivedStateFromProps&&null==l&&null!=f.componentWillReceiveProps&&f.componentWillReceiveProps(k,M),!l&&null!=f.shouldComponentUpdate&&!1===f.shouldComponentUpdate(k,f.__s,M)){for(f.props=k,f.state=f.__s,f.__d=!1,f.__v=n,n.__e=null!=c?c!==o.__e?c:o.__e:null,n.__k=o.__k,p=0;p<n.__k.length;p++)n.__k[p]&&(n.__k[p].__p=n);break e}null!=f.componentWillUpdate&&f.componentWillUpdate(k,f.__s,M)}for(g=f.props,m=f.state,f.context=M,f.props=k,f.state=f.__s,(p=t.__r)&&p(n),f.__d=!1,f.__v=n,f.__P=e,p=f.render(f.props,f.state,f.context),n.__k=b(null!=p&&p.type==d&&null==p.key?p.props.children:p),null!=f.getChildContext&&(s=u(u({},s),f.getChildContext())),_||null==f.getSnapshotBeforeUpdate||(P=f.getSnapshotBeforeUpdate(g,m)),y(e,n,o,s,r,i,a,c,h),f.base=n.__e;p=f.__h.pop();)f.__s&&(f.state=f.__s),p.call(f);_||null==g||null==f.componentDidUpdate||f.componentDidUpdate(g,m,P),w&&(f.__E=f.__p=null)}else n.__e=x(o.__e,n,o,s,r,i,a,h);(p=t.diffed)&&p(n)}catch(e){t.__e(e,n,o)}return n.__e}function M(e,n){for(var o;o=e.pop();)try{o.componentDidMount()}catch(e){t.__e(e,o.__v)}t.__c&&t.__c(n)}function x(e,t,n,o,s,r,l,u){var c,h,p,d,v=n.props,f=t.props;if(s="svg"===t.type||s,null==e&&null!=r)for(c=0;c<r.length;c++)if(null!=(h=r[c])&&(null===t.type?3===h.nodeType:h.localName===t.type)){e=h,r[c]=null;break}if(null==e){if(null===t.type)return document.createTextNode(f);e=s?document.createElementNS("http://www.w3.org/2000/svg",t.type):document.createElement(t.type),r=null}return null===t.type?v!==f&&(null!=r&&(r[r.indexOf(e)]=null),e.data=f):t!==n&&(null!=r&&(r=a.slice.call(e.childNodes)),p=(v=n.props||i).dangerouslySetInnerHTML,d=f.dangerouslySetInnerHTML,u||(d||p)&&(d&&p&&d.__html==p.__html||(e.innerHTML=d&&d.__html||"")),function(e,t,n,o,s){var r;for(r in n)r in t||w(e,r,null,n[r],o);for(r in t)s&&"function"!=typeof t[r]||"value"===r||"checked"===r||n[r]===t[r]||w(e,r,t[r],n[r],o)}(e,f,v,s,u),t.__k=t.props.children,d||y(e,t,n,o,"foreignObject"!==t.type&&s,r,l,i,u),u||("value"in f&&void 0!==f.value&&f.value!==e.value&&(e.value=null==f.value?"":f.value),"checked"in f&&void 0!==f.checked&&f.checked!==e.checked&&(e.checked=f.checked))),e}function A(e,n,o){try{"function"==typeof e?e(n):e.current=n}catch(e){t.__e(e,o)}}function I(e,n,o){var s,r,i;if(t.unmount&&t.unmount(e),(s=e.ref)&&A(s,null,n),o||"function"==typeof e.type||(o=null!=(r=e.__e)),e.__e=e.l=null,null!=(s=e.__c)){if(s.componentWillUnmount)try{s.componentWillUnmount()}catch(e){t.__e(e,n)}s.base=s.__P=null}if(s=e.__k)for(i=0;i<s.length;i++)s[i]&&I(s[i],n,o);null!=r&&c(r)}function C(e,t,n){return this.constructor(e,n)}t={},v.prototype.setState=function(e,t){var n=this.__s!==this.state&&this.__s||(this.__s=u({},this.state));("function"!=typeof e||(e=e(n,this.props)))&&u(n,e),null!=e&&this.__v&&(this.u=!1,t&&this.__h.push(t),g(this))},v.prototype.forceUpdate=function(e){this.__v&&(e&&this.__h.push(e),this.u=!0,g(this))},v.prototype.render=d,n=[],o="function"==typeof Promise?Promise.prototype.then.bind(Promise.resolve()):setTimeout,s=t.debounceRendering,t.__e=function(e,t,n){for(var o;t=t.__p;)if((o=t.__c)&&!o.__p)try{if(o.constructor&&null!=o.constructor.getDerivedStateFromError)o.setState(o.constructor.getDerivedStateFromError(e));else{if(null==o.componentDidCatch)continue;o.componentDidCatch(e)}return g(o.__E=o)}catch(t){e=t}throw e},r=i;let N=function(){};void 0===Date.now&&(Date.now=function(){return(new Date).getTime()});var $,D,B,R=2,T=4,U=6,W=8,E=10,O=12,F=[[],[],[],[],[1,10,-1,-10],[],[21,19,12,8,-21,-19,-12,-8],[],[11,9,-11,-9],[],[1,10,11,9,-1,-10,-11,-9],[],[1,10,11,9,-1,-10,-11,-9],[]],K=[0,0,20,20,100,100,60,60,61,61,8e3,8e3,180,180,0],L=K[10],q=L>>1,Q=300,z=L-250,j=-9999,H={P:2,p:3,R:4,r:5,N:6,n:7,B:8,b:9,K:10,k:11,Q:12,q:13};let G="  ♙♟♖♜♘♞♗♝♔♚♕♛";function J(e,t,n,o,s,r,i,a){var l,u=te(e,s,r,O),c=1-n,h=V(e,n,u.ep,-o),p=h.length;if(t){var d;for(l=0;l<p;l++){var v=h[l],f=v[0],_=v[1],g=v[2];if(f>q){i=L;break}if((d=-J(e,t-1,c,f,_,g,-a,-i))>i&&(i=d),i>=a)break}i<-z&&!Z(e,n)&&(i=e.stalemate_scores[n]),i<-q&&(i+=Q)}else for(;a>i&&-1!=--p;)h[p][0]>i&&(i=h[p][0]);return ne(e,u),i}function Y(e){var t,n,o,s,r,i=e.pieces=[[],[]],a=e.moveno>>1,l=e.board;a>50||parseInt(6*Math.exp(-.07*a));var u=a<12,c=a<5,h=[0,0],p=[0,0],d=[0,0];for(t=20;t<100;t++){var v=14&(r=l[t]),f=1&r;v&&(i[f].push([r,t]),v==E?h[f]=t:(p[f]+=K[v],d[f]=Math.max(d[f],K[v])))}var _=e.draw_timeout>90||e.current_repetitions>=2;_&&N("draw likely",e.current_repetitions,e.draw_timeout),e.values=[[],[]];var g=K[O],m=p[0]+p[1]+2*g,y=2*(p[1]+g)/m,b=2*(p[0]+g)/m,P=[y,b],w=4*O/m;for(e.stalemate_scores=[parseInt(.5+2*(y-1)*g),parseInt(.5+2*(b-1)*g)],t=0;t<K.length;t++){var k=K[t];k<q?(e.values[0][t]=parseInt(k*y+.5),e.values[1][t]=parseInt(k*b+.5)):(e.values[0][t]=k,e.values[1][t]=k)}e.best_pieces=[parseInt(d[0]*y+.5),parseInt(d[1]*b+.5)];var S=[h[0]%10,h[1]%10],M=[parseInt(h[0]/10),parseInt(h[1]/10)],x=[[],[]];for(s=3;s<9;s++)for(o=1;o<9;o++)(14&(r=l[t=10*s+o]))==R&&(0==(1&r)?x[0][o]=s:void 0===x[1][o]&&(x[1][o]=s));var A=a>=20||m<5*g,I=e.weights;for(s=2;s<10;s++)for(o=1;o<9;o++)for(var C=0*$[t=10*s+o],F=B[t],L=0;L<2;L++){var Q=Math.abs(S[1-L]-o),z=Math.abs(M[1-L]-s),j=Math.abs(S[L]-o),H=Math.max(Math.sqrt(Q*Q+z*z),1)+1,G=P[L],J=G*G*G,Y=s==2+7*L,V=s==3+5*L,X=s==5+L,Z=s==9-7*L,ee=-5*(c&&Y),te=parseInt(.3*C)+2*F+ee,ne=parseInt(.3*C),oe=parseInt(.6*C)+F+ee;Y&&(ne+=(4==o||5==o)*(0+!A),ne+=(1==o||8==o)*(a>10&&a<20)*-3,ne+=(2==o||7==o)*(a>10&&a<20)*-1);var se=parseInt(.5*F+C*(.5-c)),re=2*(u&&Y)*0,ie=Math.max(2*w,1)*D[L?119-t:t];if(c){if(s>=4&&s<=7)ie+=parseInt(.1*(1+3*(5==s||6==s)+be(e,4))*C);4!=o&&5!=o||(ie-=3*V,ie+=3*X)}Z&&(ie+=e.values[L][O]-e.values[L][R]),ie+=4*(3==s&&2==M[L]&&Math.abs(j)<2&&5!=S[L]&&4!=o&&5!=o);var ae=x[1-L];if((null==ae[o]||0==L&&ae[o]<s||1==L&&ae[o]>s)&&(ie+=2),A){te+=2*parseInt(8*G/H),ne+=2*((Q<2)+(z<2)),oe+=3*(Math.abs(Q-z)<2),se+=2*parseInt(8/H)+(Q*z==0)+(Q-z==0);var le=8*w*$[t];re+=parseInt(150*w/(J*H)+le*J)}if(I[R+L][t]=ie,I[U+L][t]=te,I[T+L][t]=ne,I[W+L][t]=oe,I[O+L][t]=se,I[E+L][t]=re,_&&G<1){var ue=3/J;for(n=2+L;n<14;n+=2)I[n][t]+=be(e,ue)}}e.prepared=!0}function V(e,t,n,o){var s,r,i,a,l,u,c,h=e.board,p=1-t,d=10-20*t,v=[],f=[],_=e.pieces[t],g=e.castles>>2*t&3,m=e.values[p],y=e.weights;for(u=_.length-1;u>=0;u--){var b=y[a=h[s=_[u][1]]];if(c=o-b[s],(a&=14)>2){var P=F[a];if(2&a){for(l=0;l<8;l++)(i=h[r=s+P[l]])?(17&i)==p&&f.push([c+m[i]+b[r]+y[i][r],s,r]):v.push([c+m[i]+b[r],s,r]);a==E&&g&&(1&g&&h[s-1]+h[s-2]+h[s-3]==0&&X(h,s-2,p,d,-1)&&v.push([c+12,s,s-2]),2&g&&h[s+1]+h[s+2]==0&&X(h,s,p,d,1)&&v.push([c+13,s,s+2]))}else{var w=P.length;for(l=0;l<w;){var k=P[l++];r=s;do{(i=h[r+=k])?(17&i)==p&&f.push([c+m[i]+b[r]+y[i][r],s,r]):v.push([c+m[i]+b[r],s,r])}while(!i)}}}else{if(!h[r=s+d]){v.push([c+b[r],s,r]);var S=r+d;s*(120-s)<3200&&!h[S]&&v.push([c+b[S],s,S])}(i=h[--r])&&(17&i)==p&&f.push([c+m[i]+b[r]+y[i][r],s,r]),(i=h[r+=2])&&(17&i)==p&&f.push([c+m[i]+b[r]+y[i][r],s,r])}}if(n){var M,x=R|t;h[s=n-d-1]==x&&(M=m[R]+y[R|p][n-d],f.push([o-b[s]+b[n]+M,s,n])),h[s+=2]==x&&(M=m[R]+y[R|p][n-d],f.push([o-b[s]+b[n]+M,s,n]))}return f.concat(v)}function X(e,t,n,o,s){var r,i,a,l=n+U,u=W|n,c=T|n,h=2|n;for(a=t;a<t+3;a++){r=a;do{i=e[r+=o]}while(!i);if((23&i)==c)return 0;r=a;var p=o-1;do{i=e[r+=p]}while(!i);if((27&i)==u)return 0;r=a,p+=2;do{i=e[r+=p]}while(!i);if((27&i)==u)return 0;if(e[a+o-2]==l||e[a+o+2]==l)return 0}for(a=t+o-1;a<t+o+4;a++)if((i=23&e[a])==h||e[a+o]==l)return 0;r=s<0?t+2:t;do{i=e[r-=s]}while(!i);return(23&i)==c?0:1}function Z(e,t){var n,o=e.board,s=e.pieces[t],r=s.length;if(!r)return!1;do{n=s[--r]}while(n[0]!=(E|t));var i=n[1],a=1-t,l=10-20*t;if(o[i+l-1]==(R|a)||o[i+l+1]==(R|a))return!0;var u=F[U],c=F[E],h=U|a,p=E|a;for(r=0;r<8;r++)if(o[i+u[r]]==h||o[i+c[r]]==p)return!0;var d=F[W],v=F[T],f=W|a,_=T|a;for(r=0;r<4;r++){var g,m=d[r],y=i;do{g=o[y+=m]}while(!g);if((27&g)==f)return!0;m=v[r],y=i;do{g=o[y+=m]}while(!g);if((23&g)==_)return!0}return!1}function ee(e,t,n,o){Y(e),function(e){for(var t,n,o,s=[V(e,0,0,0),V(e,1,0,0)],r=(e.weights,e.board),i=0;i<2;i++){var a=e.values[i],l=e.pieces[i],u=s[i],c=s[1-i],h=[];for(t=0;t<l.length;t++)h[(n=l[t])[1]]={score:0,piece:n[0],pos:n[1],threatened:0};for(t=u.length-1;t>=0;t--){var p=(d=u[t])[0];o=d[1],r[d[2]]||((v=h[o]).score=Math.max(v.score,p))}for(t=c.length-1;t>=0;t--){var d,v;if(void 0!==(v=h[(d=c[t])[2]])){var f=r[d[1]],_=.01*(1+v.piece>3+f<4);v.threatened<_&&(v.threatened=_)}}var g=[];for(t=20;t<100;t++)void 0!==(n=h[t])&&(n.score+=n.threatened*a[n.piece],g.push(n));for(g.sort(function(e,t){return e.score-t.score}),t=0;t<g.length;t++)n=g[t],l[t]=[n.piece,n.pos]}}(e);e.board;2==arguments.length&&(n=e.to_play,o=e.enpassant);var s,r,i,a=V(e,n,o,0),l=j,u=0,c=0;if(t<=0){for(i=0;i<a.length;i++)s=a[i],a[i][0]>l&&(l=s[0],u=s[1],c=s[2]);return[u,c,l]}for(i=0;i<a.length;i++){var h=(s=a[i])[0],p=s[1],d=s[2];if(h>q){l=L,u=p,c=d;break}(r=-e.treeclimber(e,t-1,1-n,h,p,d,j,-l))>l&&(l=r,u=p,c=d)}return l<-z&&!Z(e,n)&&(l=e.stalemate_scores[n]),[u,c,l]}function te(e,t,n,o){var s=e.board,r=t>=0?s[t]:-t,i=s[n];n>=0&&(s[n]=r),t>=0&&(s[t]=0);var a,l,u,c=14&r,h=1&r,p=r,d=0,v=0,f=0;if(t>=0){c==R?(60-n)*(60-n)>900?(o|=h,s[n]=o,p=o):1&(t^n)&&0==i?(v=s[u=n-10+20*h],s[u]=0):(t-n)*(t-n)==400&&(f=t+n>>1):c==E&&(t-n)*(t-n)==4&&(a=t+n>>1,l=h+T,s[d=t-4+7*(t<n)]=0,s[a]=l);var _=e.castles;if(_){var g=0,m=2*h,y=70*h,b=t-y,P=n+y;25==b?g|=3<<m:21==b?g|=1<<m:28==b&&(g|=2<<m),91==P?g|=4>>m:98==P&&(g|=8>>m),e.castles&=~g}}for(var w=e.pieces.concat(),k=w[h],S=e.pieces[h]=[],M=0;M<k.length;M++){(C=k[M])[0];var x=C[1];x!=t&&x!=d&&S.push(C)}if(S.push([p,n]),l&&S.push([l,a]),i||v){var A=w[1-h];S=e.pieces[1-h]=[];var I=v?u:n;for(M=0;M<A.length;M++){var C;(C=A[M])[1]!=I&&S.push(C)}}return{s:t,e:n,S:r,E:i,ep:f,castles:_,rs:d,re:a,rook:l,ep_position:u,ep_taken:v,pieces:w}}function ne(e,t){var n=e.board;t.ep_position&&(n[t.ep_position]=t.ep_taken),t.s>=0&&(n[t.s]=t.S),n[t.e]=t.E,t.rs&&(n[t.rs]=t.rook,n[t.re]=0),e.pieces=t.pieces,e.castles=t.castles}var oe=1,se=2,re=4,ie=8,ae=16,le=32,ue=64,ce=0;function he(e,t,n,o){var s=e.board,r=e.to_play,i=1-r;if(t!=parseInt(t))if(void 0===n){var a=function(e,t){var n=[0,0],o=/^[a-h][1-8]$/,s=/^\s*([RNBQK]?[a-h]?[1-8]?)[ :x-]*([a-h][1-8]?)(=[RNBQ])?[!?+#e.p]*\s*$/.exec(t);if(null==s){if(!(s=/^\s*([O0o]-[O0o](-[O0o])?)\s*$/.exec(t)))return n;r=25+70*e.to_play,i=s[2]?r-2:r+2}var r,i,a,l=s[1],u=s[2],c=s[3];""==l||null==l?(i=fe(u),r=me(e,i,"P"+u.charAt(0))):/^[RNBQK]/.test(l)?(i=fe(u),r=me(e,i,l)):o.test(l)&&o.test(u)?(r=fe(l),i=fe(u)):/^[a-h]$/.test(l)&&(i=fe(u),r=me(e,i,"P"+l));if(0==r)return n;c&&(a=H[c.charAt(1)]);return[r,i,a]}(e,t);if(t=a[0],n=a[1],0==t)return{flags:ce,ok:!1};o=a[2]}else t=fe(t),n=fe(n);void 0===o&&(o=O);s[n];var l,u=t>=0?s[t]:-t,c=!1;if(function(e){e.prepared||Y(e)}(e),t>=0){var h=V(e,r,e.enpassant,0);for(l=0;l<h.length;l++)if(n==h[l][2]&&t==h[l][1]){c=!0;break}if(!c)return{flags:ce,ok:!1}}var p=te(e,t,n,o);if(t>=0&&Z(e,r))return ne(e,p),{flags:ce,ok:!1,string:"in check!"};var d=oe;e.enpassant=p.ep,e.history.push([t,n,o]),e.moveno++,p.E||p.ep_position?(e.draw_timeout=0,d|=ie):(14&u)==R?e.draw_timeout=0:e.draw_timeout++,p.rs&&(d|=t>n?le:ae);var v=de(e,!0),f=(e.position_counts[v]||0)+1;e.position_counts[v]=f,e.current_repetitions=f,(e.draw_timeout>100||f>=3||function(e){var t,n=!1,o=void 0,s=e.board;for(t=20;t<100;t++){var r=14&s[t];if(0!=r&&r!=E)if(r==U){if(n||void 0!==o)return!1;n=!0}else{if(r!=W)return!1;var i=1&t^1&parseInt(t/10);if(n)return!1;if(void 0===o)o=i;else if(o!=i)return!1}}return!0}(e))&&(d|=ue),t>=0&&(e.to_play=i),Z(e,i)&&(d|=se);var _=!0,g=V(e,i,p.ep,0);for(l=0;l<g.length;l++){var m=g[l],y=te(e,t>=0?m[1]:t,m[2],O),b=Z(e,i);if(ne(e,y),!b){_=!1;break}}_&&(d|=re);var P=function(e,t,n,o,s,r,i){var a,l,u,c,h=14&o,p=r&ie;if(n<0)return"-";if(l=ve(n),t<0)return G.charAt(o)+l;if(a=ve(t),h==R)u=p?a.charAt(0)+"x"+l:l,(n>90||n<30)&&(void 0===s&&(s=O),u+="="+G.charAt(s)),u=G.charAt(o)+u;else if(h==E&&(t-n)*(t-n)==4)u=n<t?"O-O-O":"O-O";else{var d="",v="",f=G.charAt(o),_=t%10,g=parseInt(t/10),m=[];for(c=0;c<i.length;c++){var y=i[c];n==y[2]&&t!=y[1]&&e.board[y[1]]==o&&m.push(y[1])}if(m.length){for(c=0;c<m.length;c++){var b=m[c],P=b%10,w=parseInt(b/10);P==_&&(d=a.charAt(1)),w==g&&(v=a.charAt(0))}""==d&&""==v&&(v=a.charAt(0))}u=f+v+d+(p?"x":"")+l}r&se?u+=r&re?"#":"+":r&re&&(u+=" stalemate");return u}(e,t,n,u,o,d,h);return e.historyStrings.push(P),e.prepared=!1,d&re?e.over=e.to_play+1:d&ue&&(e.over=3),{flags:d,string:P,ok:!0}}function pe(e,t){void 0===t||t>e.moveno?t=e.moveno:t<0&&(t=e.moveno+t);for(var n,o,s=_e(e.beginning),r=0;s.moveno<t;){var i=e.history[r++];he(s,i[0],i[1],i[2])}for(n in s){var a=s[n];if(n instanceof Array)for((o=e[n]).length=0,r=0;r<a.length;r++)o[r]=a[r];else e[n]=a}e.prepared=!1}function de(e,t){for(var n=e.board,o="",s=9;s>1;s--){for(var r=0,i=1;i<9;i++){var a=n[10*s+i];0==a?r++:(r&&(o+=r.toString()),o+="  PpRrNnBbKkQq".charAt(a),r=0)}r&&(o+=r),s>2&&(o+="/")}if(o+=" "+"wb".charAt(e.to_play)+" ",e.castles)for(var l=[2,"K",1,"Q",8,"k",4,"q"],u=0;u<8;u+=2)e.castles&l[u]&&(o+=l[u+1]);else o+="-";return 0!==e.enpassant?o+=" "+ve(e.enpassant):o+=" -",t?o:(o+=" "+e.draw_timeout+" ",o+=1+(e.moveno>>1))}function ve(e){var t=e%10,n=(e-t)/10-1;return" abcdefgh".charAt(t)+n}function fe(e){var t=parseInt(e.charAt(0),19)-9,n=parseInt(e.charAt(1))+1;if(n>=2&&n<10&&t>=1&&t<9)return 10*n+t}function _e(e,t){void 0===t&&(t=function(){var e=ge();$=ge(),D=ge(),B=ge();for(var t=0;t<120;t++){var n=parseInt(t/10),o=t%10,s=Math.abs(o-4.5),r=Math.abs(n-5.5);$[t]=parseInt(6-Math.pow(1.5*(s*s+r*r),.6)),B[t]=parseInt((s<2)+1.5*(r<2)+(s<3)+(r<3))-2,D[t]=parseInt("000012347000".charAt(n)),(n>9||n<2||o<1||o>8)&&(e[t]=16)}var i=[];for(t=0;t<14;t++)i[t]=ge();var a={board:e,weights:i,history:[],treeclimber:J};return function(e,t){t&=4294967295,e.rng=new Uint32Array(4),e.rng[0]=4058668781,e.rng[1]=t,e.rng[2]=t,e.rng[3]=t;for(var n=0;n<20;n++)ye(e)}(a,Date.now()),a}());var n=t.board,o=e.split(" "),s=o[0],r=o[1],i=o[2],a=o[3],l=o[4],u=o[5];void 0===l&&(l=0);for(var c,h,p=90,d=1,v=0;v<s.length;v++)if("/"!=(h=s.charAt(v))){var f=H[h];if(f&&d<9)n[p+d]=f,d++;else for(var _=Math.min(d+parseInt(h),9);d<_;d++)n[p+d]=0}else if(d=1,(p-=10)<20)break;t.to_play="b"==r.toLowerCase()?1:0,t.castles=0;var g=n[25]==E,m=n[95]==E+1,y={k:8*(m&&n[98]==T+1),q:4*(m&&n[91]==T+1),K:2*(g&&n[28]==T),Q:1*(g&&n[21]==T)};for(c=0;c<i.length;c++){var b=y[h=i.charAt(c)];void 0!==b&&(t.castles|=b,0==b&&console.log("FEN claims castle state "+i+" but pieces are not in place for "+h))}if(t.enpassant="-"!=a?fe(a):0,t.draw_timeout=parseInt(l),void 0===u)for(p=20;p<100;p+=10)for(d=1;d<9;d++)15&n[p+d],d<8&&n[p+d+1],p<90&&n[p+d+10];return t.moveno=2*(parseInt(u)-1)+t.to_play,t.history=[],t.historyStrings=[],t.beginning=e,t.prepared=!1,t.over=0,t.position_counts={},t.move=function(e,t,n){return he(this,e,t,n)},t.findmove=function(e){return ee(this,e)},t.jump_to_moveno=function(e){return pe(this,e)},t}function ge(){return new Int32Array(120)}function me(e,t,n){var o,s,r,i,a=e.to_play,l=H[n.charAt(0)];for(l|=a,s=1;s<n.length;s++){var u=n.charAt(s);/[a-h]/.test(u)?i=n.charCodeAt(s)-96:/[1-8]/.test(u)&&(r=1+parseInt(u))}var c=[];Y(e);var h=V(e,a,e.enpassant,0);for(s=0;s<h.length;s++){var p=h[s];if(t==p[2]&&(o=p[1],!(e.board[o]!=l||void 0!==i&&i!=o%10||void 0!==r&&r!=parseInt(o/10)))){var d=te(e,o,t,O);Z(e,a)||c.push(o),ne(e,d)}}return 0==c.length?0:c[0]}function ye(e){var t=e.rng,n=t[1],o=t[2],s=t[0]-(n<<27|n>>>5);return t[0]=n^(o<<17|o>>>15),t[1]=o+t[3]&4294967295,t[2]=t[3]+s&4294967295,t[3]=s+t[0]&4294967295,2147483647&t[3]}function be(e,t){var n,o=t;o--,o|=o>>>1,o|=o>>>2,o|=o>>>4,o|=o>>>8,o|=o>>>16;do{n=ye(e)&o}while(n>=t);return n}const Pe=1,we=2,ke=3,Se=4,Me=0,xe=1,Ae="wswn_";function Ie(){return"ontouchstart"in window||navigator.maxTouchPoints}const Ce="  PpRrNnBbKkQq",Ne=80,$e=!1;let De=[0,0,1,-1,5,-5,3,-3,3,-3,0,0,9,-9];const Be=[{name:"Start With Nothing",bag:"KPRPBPNPQPNPBPRP",board:"rnbqkbnr/pppppppp/8/8/8/8/8/8 b kq - 0 1",description:'"Classic" mode. You place all usual white pieces in order, black starts with all pieces already in place.\n    Note that you can "Pass" the piece placement. You can use it to try and win with the least pieces placed possible.\n    '},{name:"Human Wave",bag:"KPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPPP",board:"rnbqkbnr/pppppppp/8/8/8/8/8/8 b kq - 0 1",description:'Plays by the same rules as "Start with Nothing", but you only can place King and (a lot of) Pawns.'},{name:"Randomised",bag:"KPRPBPNPQPNPBPRP",board:"rnbqkbnr/pppppppp/8/8/8/8/8/8 b kq - 0 1",random:!0,description:"In this mode order of pieces (other than King) is randomised."},{name:"Double Nothing",bag:"KpPrRpPbBpPnNpPqPpPnNpPbBpPrRpP",board:"4k3/4p3/8/8/8/8/8/8 b - - 0 1",description:"Both sides start with (nearly) nothing, and you place pieces for both of them."}];function Re(e){return new Promise(t=>setTimeout(t,e))}function Te(e){const t=[...e.board.filter((e,t)=>t>20&&t<100&&t%10<=8&&t%10>0)].map(e=>e>=2?Ce[e]:null);let n=[];for(;t.length>0;)n.push(t.splice(0,8));return[].concat(...n.reverse())}function Ue(e){return e.map(e=>8*(9-Math.floor(e/10))+e%10-1)}function We(e){return e.map(e=>e<0?e:10*(8-Math.floor(e/8))+e%8+11).slice(0,2)}const Ee=0,Oe=1,Fe=2;class Ke extends v{render({cols:e,rows:t,Cell:n,position:o}){let s=this.props.animation,r=s&&s.cell;return h("div",{class:"board",onMouseLeave:e=>this.props.onMouse(Ee,-1)},h("div",{class:"board-grid",style:`\n          grid-template-columns: repeat(${e}, ${Ne}px);\n          grid-auto-rows: ${Ne}px;\n          border-radius: ${.5*Ne}px;\n          border: none;\n          padding: ${.5*Ne}px;        \n          `},[...new Array(e*t)].map((t,i)=>h(n,{ind:i,col:i%e,row:Math.floor(i/e),code:o[i],possibleMove:this.props.canDropAt(i),onMouse:this.props.onMouse,animation:r!=i?null:[s.x,s.y]}))),h("div",{class:"board-numbers",style:`\n          top: ${.9*Ne}px;\n          font-size: ${.4*Ne}px;\n          margin-left: ${.15*Ne}px;\n          grid-template-rows: repeat(${t}, ${Ne}px);\n          `},[...new Array(e)].map((e,t)=>h("div",null,8-t))),h("div",{class:"board-letters",style:`\n          top: ${Ne*(t+.55)}px;\n          font-size: ${.4*Ne}px;\n          margin-left: ${.5*Ne}px;\n          grid-template-columns: repeat(${t}, ${Ne}px);\n          `},[...new Array(e)].map((e,t)=>h("div",null,String.fromCharCode(65+t)))))}}const Le=({code:e,animation:t})=>{if(!e)return h("span",null);const n=" prnbkq".indexOf(e.toLowerCase()),o=n>=0?" ♟♜♞♝♚♛"[n]:e,s=n>=0&&e.toUpperCase()==e;return h("span",{style:t?`top:${t[1]}; left:${t[0]}; z-index:10;`:null,class:"board-cell-content "+(s?"white":"black")},o)};class qe extends v{render(e){return h("div",{onMouseDown:t=>0==t.button&&e.onMouse(Oe,e.ind),onMouseUp:t=>0==t.button&&e.onMouse(Fe,e.ind),onMouseMove:t=>e.onMouse(Ee,e.ind),class:(this.props.col%2==e.row%2?"even":"odd")+" board-cell"+(e.possibleMove?" possible-move":"")},e.possibleMove?h("span",{class:"possible-marker"}):e.code&&h(Le,{code:e.code,animation:e.animation}))}}class Qe extends v{render(){return h("div",{class:"vertical menu"},h("h1",null,"White Starts With Nothing"),h("div",{class:"horisontal"},h("div",{class:"modes"},"Select game mode",h("div",{class:"modes-grid"},Be.map((e,t)=>h("button",{onClick:e=>this.props.start(t)},e.name))),this.props.continue&&h("button",{class:"menu-continue",onClick:this.props.continue},"Continue")),this.props.saves.length>0&&[h("div",{class:"vertical-line"}),h("div",{class:"saves"},h("div",{style:"grid-column-end: span 2;"},"or load a save"),this.props.saves.map((e,t)=>[h("button",{class:"load-button"+(e[0]==this.props.currentSave?" last-save":""),onClick:e=>this.props.saveAction(Me,t)},e[1]?h("small",null,(e[1].board||Be[0].board).replace(/\//g," ")+" "+Be[e[1].moden].name):"Save"),h("button",{class:"x-button",disabled:!e[1],onClick:e=>this.props.saveAction(xe,t)},"X")]))]))}}class ze extends v{constructor(){super(),this.state={position:null,dragged:null,over:0,paused:!1,autoPlay:!1,page:ke,currentSave:null,saves:[],history:[],draggedFrom:null,mouseAt:[0,0],animation:null,moden:0,newmoden:0},this.animation=null,this.seed=0,this.passes=0,this.canDropAt=(e=>{let t=this.state.dragged;return!!t&&(!this.state.position[e]&&("P"==t?e>=32&&e<56:"p"==t?e>=8&&e<32:t.toUpperCase()==t?e>=32:e<32))}),this.cancelDragging=(()=>{if(this.state.draggedFrom){let e=this.state.position.slice();e[this.state.draggedFrom]=this.state.dragged,this.setState({position:e,dragged:null,draggedFrom:null})}}),this.onMouse=((t,n)=>e(this,void 0,void 0,function*(){let{dragged:e,draggedFrom:o,position:s}=this.state;if(t==Ee&&n<0&&this.setState({mouseAt:null}),t==Oe){if(this.over)return;if(!this.canDropAt(n))return;if(n==o)return void this.cancelDragging();let t=s[n];if("·"!=t&&t&&!e&&$e&&((s=s.slice())[n]="·",console.log((Y(r=this.game),V(r,r.to_play,r.enpassant,0).map(([e,t,n])=>Ue([t,n])))),this.setState({position:s,dragged:t,draggedFrom:n})),e)if(o){let e=We([o,n]);this.game.move(...e).ok&&(this.syncPosition(),this.setState({dragged:null,draggedFrom:null}),this.aiMove())}else{let t=We([-Ce.indexOf(e),n]);this.fullMove(t)}}var r})),this.mouseMove=(e=>{this.setState({mouseAt:e})}),this.pass=(()=>{this.fullMove([-1,-1]),this.passes++}),this.undo=(()=>e(this,void 0,void 0,function*(){this.canUndo()&&(pe(this.game,3*Math.floor(this.game.moveno/3-1)+1),this.syncPosition())})),this.save=(e=>{e||(e=this.state.currentSave),localStorage.setItem(e,this.serialize()),localStorage.setItem(Ae+"current",e),console.log(this.game.history)}),this.load=(e=>{e||(e=this.state.currentSave);let t=localStorage.getItem(e);return!!t&&(this.deserialize(t),localStorage.setItem(Ae+"current",e),!0)}),this.toggleMenu=(()=>{this.syncSaves(),this.setState(e=>({page:e.page==we?Pe:we}))}),this.goPage=(e=>{this.setState({page:e})}),this.pause=(()=>e(this,void 0,void 0,function*(){let e=this.state.paused;this.setState({paused:!e}),yield Re(10),e&&this.autoPlay()})),this.saveAction=((e,t)=>{let n=this.state.saves[t];e==xe?(localStorage.removeItem(n[0]),this.state.currentSave==n[0]&&localStorage.removeItem(Ae+"current")):e==Me&&(this.state.saves[t][1]?(this.load(n[0]),this.goPage(Pe)):this.save(n[0])),this.syncSaves()}),this.start=(t=>e(this,void 0,void 0,function*(){this.setState({newmoden:t}),this.goPage(Se)})),this.reallyStart=(t=>e(this,void 0,void 0,function*(){this.init(String(t)),yield Re(0),this.save(Ae+(this.state.maxSave+1)),this.syncSaves(),this.goPage(Pe)})),this.continue=(()=>{this.game||this.load(this.state.currentSave)||this.init(0),this.goPage(Pe)}),this.init(),document.addEventListener("mousedown",e=>{this.state.mouseAt||this.cancelDragging()})}get currentBagPiece(){return!this.over&&this.bag[Math.floor(this.game.moveno/3)-this.passes]}nextBagPiece(){return this.currentBagPiece}init(e="empty"){if("empty"!=e){let n=0;n=e in Be?Number(e):Be.findIndex(t=>t.name==e);let o=Be[n];this.passes=0,this.bag=o.bag+"",o.random&&(this.seed||(this.seed=Math.random()),this.rng=(t=this.seed,()=>{const e=1e4*Math.sin(t++);return e-Math.floor(e)}),this.bag=this.bag.substr(0,1)+this.bag.substr(1).split("").sort(()=>this.rng()>.5?1:-1).join("")),this.game=_e(o.board),this.nextBagPiece(),this.setState({moden:n,over:0,paused:!1,autoPlay:!1}),this.syncPosition(),this.syncSaves()}else this.syncSaves();var t}syncSaves(){let e=[],t=0,n=Ae.length,o=[];for(let e in localStorage)if(e.substr(0,n)==Ae){if(e==Ae+"current")continue;o.push(e);let s=Number(e.substr(n))||0;t=Math.max(s,t)}let s=localStorage[Ae+"current"];for(let t of o)e.push([t,JSON.parse(localStorage[t]||null)]);return this.game&&e.push([Ae+(t+1),null]),e.sort((e,t)=>e[0]>t[0]?1:-1),this.setState({currentSave:s,saves:e,maxSave:t}),e}get over(){return this.game.over}aiMove(){return e(this,void 0,void 0,function*(){if(this.over)return;let e=this.game.findmove(4);this.game.move(e[0],e[1]),yield this.animateMove(...Ue(e))})}fullMove(t){return e(this,void 0,void 0,function*(){this.game.move(...t),this.syncPosition(),this.setState({dragged:null,draggedFrom:null}),yield this.aiMove(),yield this.aiMove(),this.nextBagPiece(),this.syncPosition(),this.save(),this.currentBagPiece||this.over||(this.setState({autoPlay:!0}),this.autoPlay())})}canUndo(){return this.game.moveno>=4&&(this.currentBagPiece||this.over)}autoPlay(){return e(this,void 0,void 0,function*(){for(;!this.over&&!this.state.paused;)console.log(this.state),this.game.move(-1,-1),this.passes++,yield this.aiMove(),yield this.aiMove()})}animateMove(t,n){return e(this,void 0,void 0,function*(){return yield Re(10),new Promise(o=>{let{position:s}=this.state;t>=0&&(s[n]=s[t],s[t]=null),this.animation={cell:n,x:Ne*(t%8-n%8),y:Ne*(Math.floor(t/8)-Math.floor(n/8)),stage:1},this.setState({position:s,animation:this.animation});let r=setInterval(()=>e(this,void 0,void 0,function*(){this.setState({animation:{cell:this.animation.cell,x:this.animation.x*this.animation.stage,y:this.animation.y*this.animation.stage}}),this.animation.stage-=.04,this.animation.stage<=0&&(clearInterval(r),this.setState({animation:null}),this.syncPosition(),console.log("anim end"),o())}),20)})})}syncPosition(){this.setState({position:Te(this.game),dragged:this.currentBagPiece,history:this.game.historyStrings,over:this.game.over})}jumpTo(e){console.log(e),pe(this.game,3*Math.floor(e/3)+1),this.syncPosition()}serialize(){return JSON.stringify({moden:this.state.moden,seed:this.seed,history:this.game.history,board:de(this.game)})}calculateMaterial(){let e=0;for(let t of this.game.history)t[0]<0&&-1!=t[1]&&(e+=De[-t[0]]);return e}deserialize(e){let t=JSON.parse(e);this.seed=t.seed,this.init(t.moden),this.game.history=t.history,this.game.moveno=t.history.length+1,this.game.jump_to_moveno(this.game.moveno),this.syncPosition()}canPass(){return"K"!=this.state.dragged}render(e,{dragged:t,mouseAt:n,page:o,position:s,animation:r,history:i,paused:a,autoPlay:l}){let u=n?n.map(e=>e-Ne/2):[-100,-100];switch(o){case ke:return h("div",null,h("h1",null,"White Starts With Nothing"),h("div",{class:"intro"},"This game plays by Chess rules, but instead of moving pieces directly, you gradually place white (and in some modes, black) pieces and leave making moves to AI.",h("br",null),"Goal is, naturally, the winning of the white side. Note that you only can place pieces on respective side's half of the board, and pawns also can't be placed on the first or last row."),h("button",{onClick:e=>this.goPage(we)},"Start"));case Se:return h("div",null,h("h1",null,Be[this.state.newmoden].name),h("div",{class:"intro"},Be[this.state.newmoden].description),h("button",{onClick:e=>this.goPage(we)},"Cancel"),h("button",{onClick:e=>this.reallyStart(this.state.newmoden)},"Start"));case we:return h(Qe,{currentSave:this.state.currentSave,saves:this.state.saves,continue:(this.game||this.state.currentSave)&&this.continue,saveAction:this.saveAction,start:this.start});case Pe:return h("div",{class:"game",onMouseMove:e=>{e.target.parentNode.classList.contains("board-grid")?this.mouseMove([e.clientX,e.clientY]):this.mouseMove(null)},style:`font-size:${Math.round(.8*Ne)}px; cursor: ${t&&n?"none":"default"};`},this.over>0&&h("div",{class:"game-over"},h("h1",null,[0,"BLACK WIN","WHITE WIN","DRAW"][this.over]),h("div",null,"Turns: ",h("big",null,Math.ceil(this.game.history.length/3))," ","Placed pieces cost: ",h("big",null,this.calculateMaterial())),h("div",null,"Score (200 - Turns - Cost*3):"," ",h("big",null,200-Math.ceil(this.game.history.length/3)-3*this.calculateMaterial()))),h(Ke,{cols:8,rows:8,Cell:qe,position:s,canDropAt:this.canDropAt,onMouse:this.onMouse,animation:r}),h("div",{class:"dragged"+(Ie()?" placed-touch":""),style:Ie()?`left:10; top:${4*Ne}`:`left:${u[0]}; top:${u[1]};`},h(Le,{code:t})),h("div",null,h("button",{onClick:this.toggleMenu},"Menu"),h("button",{style:`visibility:${this.state.autoPlay?"visible":"hidden"}`,onClick:this.pause},a?"Continue":"Pause"),h("button",{onClick:this.pass,disabled:!this.canPass()},"Pass"),h("button",{onClick:this.undo,disabled:!this.canUndo()},"Undo")),h("div",{class:"history"},i.map((e,t)=>t%3==0?h("span",{onMouseDown:e=>{0==e.button&&this.jumpTo(t+1)}}," "+(t/3+1),".",i.slice(t,t+3).join(" ")):null)))}}}window.onload=function(){var e,n,o,s,l,u;e=h("div",{class:"centered"},h(ze,null)),n=document.body,t.__p&&t.__p(e,n),l=(s=o===r)?null:o&&o.__k||n.__k,e=h(d,null,[e]),u=[],S(n,s?n.__k=e:(o||n).__k=e,l||i,i,void 0!==n.ownerSVGElement,o&&!s?[o]:l?null:a.slice.call(n.childNodes),u,!1,o||i,s),M(u,e)}}();
